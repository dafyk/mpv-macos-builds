name: build

on:
  push:
    branches:
      - main
  #schedule:
    # nightly build
    #- cron: "00 12 * * *"

jobs:
  build:
    runs-on: macos-latest
    env:
      CC: clang
      CXX: clang++
      HOMEBREW_NO_ANALYTICS: 1
      HOMEBREW_NO_INSTALL_CLEANUP: 1
      MACOSX_DEPLOYMENT_TARGET: 10.13
      EXTRA_CFLAGS: "-mmacosx-version-min=10.13"
      EXTRA_CXXFLAGS: "-mmacosx-version-min=10.13"
      EXTRA_LDFLAGS: "-mmacosx-version-min=10.13"
      PKG_CONFIG_PATH: "/usr/local/lib/pkgconfig:/usr/local/opt/openssl/lib/pkgconfig:$PKG_CONFIG_PATH"
      LD_LIBRARY_PATH: "/usr/local/lib:$LD_LIBRARY_PATH"

    steps:
    - name: Get current timestamp
      id: timestamp
      run: |
        echo "::set-output name=timestamp::$(date +%s)"
        echo "::set-output name=date::$(date +%Y%m%d)"

    - name: Get latest git tag
      id: git_tag
      uses: oprypin/find-latest-tag@v1
      with:
        repository: 'dafyk/mpv-macos-builds'
        releases-only: false

    - name: Get latest mpv git tag
      id: mpv_tag
      uses: oprypin/find-latest-tag@v1
      with:
        repository: 'mpv-player/mpv'
        releases-only: false

    - name: Get number of CPU cores
      uses: SimenB/github-actions-cpu-cores@v1
      id: cpu-cores

    - name: Checkout mpv-player/mpv-build
      uses: actions/checkout@v2
      with:
        repository: 'mpv-player/mpv-build'
        fetch-depth: 0

    - name: Install dependencies
      run: |
        sudo xcode-select -s /Applications/Xcode_12.5.1.app/Contents/Developer
        # Change build version to Xcode 13.1
        #/usr/libexec/PlistBuddy -c 'Set :CFBundleVersion 19466' /Applications/Xcode_12.5.1.app/Contents/Info.plist
        export MACOSX_DEPLOYMENT_TARGET="10.13"
        export EXTRA_CFLAGS="-mmacosx-version-min=10.13"
        export EXTRA_CXXFLAGS="-mmacosx-version-min=10.13"
        export EXTRA_LDFLAGS="-mmacosx-version-min=10.13"
        brew update-reset
        for dep in $(brew --repository)/Library/Taps/homebrew/homebrew-core/Formula/*.rb; do sed -i "" $'s/def install/def install\\\n    ENV["MACOSX_DEPLOYMENT_TARGET"] = "10.13"\\\n/' $dep;done
        for dep in luajit python@3.8; do sed -i "" $'s/MacOS.version/"10.13"/' $(brew --repository)/Library/Taps/homebrew/homebrew-core/Formula//$dep.rb;done
        sed -i "" $'s/OPTIONS=\"$OPTIONS --enable-gnutls\"/OPTIONS=\"$OPTIONS --enable-openssl\"/' scripts/ffmpeg-config
        brew uninstall --ignore-dependencies --force openssl
        brew uninstall --ignore-dependencies --force gnutls
        brew uninstall --ignore-dependencies --force cairo
        brew cleanup
        brew reinstall -s automake
        brew reinstall -s pkg-config
        brew reinstall -s gettext # rebuild version already included in github actions
        brew reinstall -s glib # rebuild version already included in github actions
        brew reinstall -s gdk-pixbuf # rebuild version already included in github actions
        brew reinstall -s cairo # --HEAD rebuild version already included in github actions
        brew reinstall -s freetype
        brew reinstall -s fribidi
        brew reinstall -s harfbuzz
        brew reinstall -s libass # --HEAD
        brew reinstall -s fontconfig
        brew reinstall -s jpeg
        brew reinstall -s youtube-dl
        brew reinstall -s x264 # --HEAD
        brew reinstall -s x265 # --HEAD
        brew reinstall -s lame
        brew reinstall -s little-cms2
        brew reinstall -s openjpeg # --HEAD
        brew reinstall -s fdk-aac # --HEAD
        brew reinstall -s libxcb
        brew reinstall -s libx11
        brew reinstall -s libjpeg
        brew reinstall -s frei0r
        brew reinstall -s jpeg-xl # rebuild version already included in github actions
        brew reinstall -s brotli
        # https://github.com/mpv-player/mpv/issues/10063#issuecomment-1092413762
        install_name_tool -change "@loader_path/libbrotlicommon.1.dylib" "/usr/local/opt/brotli/lib/libbrotlicommon.1.dylib" /usr/local/opt/brotli/lib/libbrotlidec.1.dylib
        install_name_tool -change "@loader_path/libbrotlicommon.1.dylib" "/usr/local/opt/brotli/lib/libbrotlicommon.1.dylib" /usr/local/opt/brotli/lib/libbrotlienc.1.dylib
        brew reinstall -s libvmaf
        brew reinstall -s aom
        brew install luajit --HEAD
        brew reinstall -s libbluray # --HEAD
        brew reinstall -s libcaca
        brew reinstall -s dav1d
        brew reinstall -s libgsm
        brew reinstall -s libmodplug
        brew reinstall -s opencore-amr
        brew reinstall -s librsvg
        brew reinstall -s openssl@1.1
        brew reinstall -s rtmpdump
        brew reinstall -s rubberband # --HEAD
        brew reinstall -s libsoxr
        brew reinstall -s speex
        brew reinstall -s srt # --HEAD
        brew reinstall -s libssh # --HEAD
        brew reinstall -s libarchive
        brew reinstall -s tesseract
        brew reinstall -s libvidstab
        brew reinstall -s libxml2 # --HEAD
        brew reinstall -s zimg # --HEAD
        brew reinstall -s zeromq # --HEAD
        brew reinstall -s xz # needed to overide version included in macos

        echo "--enable-gl"  >> mpv_options
        echo "--enable-iconv"  >> mpv_options
        echo "--enable-lcms2"  >> mpv_options
        echo "--enable-lua"  >> mpv_options
        echo "--enable-jpeg"  >> mpv_options
        #echo "--enable-plain-gl"  >> mpv_options
        echo "--enable-zlib"  >> mpv_options
        echo "--enable-cocoa" >> mpv_options
        echo "--enable-coreaudio" >> mpv_options
        echo "--enable-gl-cocoa" >> mpv_options
        #echo "--enable-macos-cocoa-cb" >> mpv_options
        echo "--enable-macos-touchbar" >> mpv_options
        echo "--enable-videotoolbox-gl" >> mpv_options
        echo "--disable-macos-10-14-features" >> mpv_options
        #echo "--disable-swift" >> mpv_options
        #echo "--enable-libmpv-static" >> mpv_options

        echo "--enable-nonfree" >> ffmpeg_options
        echo "--enable-version3" >> ffmpeg_options
        echo "--disable-ffplay" >> ffmpeg_options
        echo "--disable-ffprobe" >> ffmpeg_options
        echo "--disable-doc" >> ffmpeg_options
        echo "--disable-htmlpages" >> ffmpeg_options
        echo "--disable-manpages" >> ffmpeg_options
        echo "--disable-podpages" >> ffmpeg_options
        echo "--disable-txtpages" >> ffmpeg_options
        echo "--enable-frei0r" >> ffmpeg_options
        echo "--enable-lcms2" >> ffmpeg_options
        echo "--enable-libaom" >> ffmpeg_options
        echo "--enable-libass" >> ffmpeg_options
        echo "--enable-libbluray" >> ffmpeg_options
        echo "--enable-libcaca" >> ffmpeg_options
        echo "--enable-libdav1d" >> ffmpeg_options
        echo "--enable-libfdk-aac" >> ffmpeg_options
        echo "--enable-libgsm" >> ffmpeg_options
        echo "--enable-libmodplug" >> ffmpeg_options
        echo "--enable-libopencore-amrnb" >> ffmpeg_options
        echo "--enable-libopencore-amrwb" >> ffmpeg_options
        echo "--enable-libopenjpeg" >> ffmpeg_options
        echo "--enable-librsvg" >> ffmpeg_options
        echo "--enable-librtmp" >> ffmpeg_options
        echo "--enable-librubberband" >> ffmpeg_options
        echo "--enable-libsoxr" >> ffmpeg_options
        echo "--enable-libspeex" >> ffmpeg_options
        echo "--enable-libsrt" >> ffmpeg_options
        echo "--enable-libssh" >> ffmpeg_options
        echo "--enable-libtesseract" >> ffmpeg_options
        echo "--enable-libvidstab" >> ffmpeg_options
        echo "--enable-libvmaf" >> ffmpeg_options
        echo "--enable-libxml2" >> ffmpeg_options
        echo "--enable-libzimg" >> ffmpeg_options
        echo "--enable-libzmq" >> ffmpeg_options

        ./rebuild -j${{ steps.cpu-cores.outputs.count }}

        cd mpv
        python3 TOOLS/osxbundle.py build/mpv
        mkdir -p release
        cp -r build/mpv.app release

    - name: Build Apple Disk Image
      if: ${{ success() && steps.mpv_tag.outputs.tag != steps.git_tag.outputs.tag }}
      run: |
        cd mpv
        brew install create-dmg
        create-dmg --sandbox-safe --no-internet-enable --volname "mpv" --app-drop-link 200 185 mpv.dmg release
        #rm -rf release/mpv.app
        mv mpv.dmg release/

    - name: Create Release
      id: create_release
      if: ${{ success() && steps.mpv_tag.outputs.tag != steps.git_tag.outputs.tag }}
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.mpv_tag.outputs.tag }}
        release_name: mpv nightly build ${{ steps.timestamp.outputs.date }}
        body: |
            mpv nightly build
            build date: ${{ steps.timestamp.outputs.date }}
            version: ${{ steps.mpv_tag.outputs.tag }}
            OS support: macOS High Sierra 10.13 or later
        draft: false
        prerelease: false

    - name: Upload Release Asset
      id: upload-release-asset
      if: ${{ success() && steps.mpv_tag.outputs.tag != steps.git_tag.outputs.tag }}
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: mpv/release/mpv.dmg
        asset_name: mpv-nightly-${{ steps.mpv_tag.outputs.tag }}.dmg
        asset_content_type: application/x-apple-diskimage
