name: build

on: workflow_dispatch
  #push:
  #  branches:
  #    - main
  #schedule:
    # nightly build
    #- cron: "00 12 * * *"

jobs:
  build:
    name: Build mpv from source
    runs-on: macos-11
    env:
      CC: clang
      CXX: clang++
      HOMEBREW_NO_ANALYTICS: 1
      HOMEBREW_NO_INSTALL_CLEANUP: 1
      #HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1
      HOMEBREW_SDKROOT: "/Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
      MACOSX_DEPLOYMENT_TARGET: "10.13"
      SDKROOT: "/Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
      MACOS_SDK: "/Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
      SDK_PATH: "/Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs"
      EXTRA_CFLAGS: "-mmacosx-version-min=10.13 -isysroot /Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
      EXTRA_CXXFLAGS: "-mmacosx-version-min=10.13 -isysroot /Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
      EXTRA_LDFLAGS: "-mmacosx-version-min=10.13 -isysroot /Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
      SWIFT_FLAGS: "-target x86_64-apple-macosx10.13"
      HOMEBREW_NO_COLOR: 1
      HOMEBREW_NO_EMOJI: 1
      HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1
    steps:
      - name: Get current timestamp
        id: timestamp
        run: |
          echo "::set-output name=timestamp::$(date +%s)"
          echo "::set-output name=date::$(date +%Y%m%d)"

      - name: Get latest mpv git tag
        id: mpv_tag
        uses: oprypin/find-latest-tag@v1
        with:
          repository: 'mpv-player/mpv'
          releases-only: false

      - name: Checkout dafyk/mpv-macos-builds
        uses: actions/checkout@v3
        with:
          repository: 'dafyk/mpv-macos-builds'
          fetch-depth: 0
          submodules: true

      - name: Install MacOSX 10.14 SDK
        id: macossdk
        run: |
          # MacOSX10.14 SDK
          tar -C $SDK_PATH -xf MacOSX10.14.sdk.tar.xz
          sudo rm -rf $SDK_PATH/MacOSX11.3.sdk
          sudo mv $SDK_PATH/MacOSX.sdk $SDK_PATH/MacOSX11.3.sdk
          sudo ln -s $SDK_PATH/MacOSX10.14.sdk $SDK_PATH/MacOSX.sdk
          sudo /usr/libexec/PlistBuddy -c "Set :MinimumSDKVersion 10.14" /Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Info.plist

      - name: Install Command Line Tools for Xcode 12.5.1
        id: macoscmdtools
        run: |
          # Command Line Tools for Xcode 12.5.1
          curl -ksJLO https://www.savero.net/Command_Line_Tools_for_Xcode_12.5.1.dmg
          sudo mv /Library/Developer/CommandLineTools /Library/Developer/CommandLineTools@13
          hdiutil attach Command_Line_Tools_for_Xcode_12.5.1.dmg
          cd /Volumes/Command\ Line\ Developer\ Tools/
          sudo installer -pkg Command\ Line\ Tools.pkg -target /

      - name: Install Swift 4.x toolchain
        id: swift4
        run: |
          # Swift 4.x toolchain
          curl -ksJLO https://download.swift.org/swift-4.2.4-release/xcode/swift-4.2.4-RELEASE/swift-4.2.4-RELEASE-osx.pkg
          sudo installer -pkg swift-4.2.4-RELEASE-osx.pkg -target /
          #curl -ksJLO https://updates.cdn-apple.com/2019/cert/061-41823-20191025-5efc5a59-d7dc-46d3-9096-396bb8cb4a73/SwiftRuntimeForCommandLineTools.dmg
          #hdiutil attach SwiftRuntimeForCommandLineTools.dmg
          #sudo installer -pkg /Volumes/SwiftRuntimeForCommandLineTools/SwiftRuntimeForCommandLineTools.pkg -target /

      - name: Switch to Xcode 12.5.1
        id: xcode1251
        run: |
          # Switch to Xcode 12.5.1
          sudo xcode-select --reset
          sudo xcode-select -s /Applications/Xcode_12.5.1.app/Contents/Developer

      - name: Instal various mpv and ffmpeg dependencies using homebrew
        id: mpvffmpegdeps
        run: |
          brew tap deus0ww/tap
          brew update-reset

          # Force 10.13 deployment target for all homebrew formulas
          find $(brew --repository)/Library/Taps -type f -iname *rb -exec sed -i "" $'s/def install/def install\\\n    ENV["MACOSX_DEPLOYMENT_TARGET"] = "10.13"\\\n/' {} \;
          #for dep in luajit python@3.8 python@3.10; do sed -i "" $'s/MacOS.version/"10.13"/' $(brew --repository)/Library/Taps/homebrew/homebrew-core/Formula//$dep.rb;done
          for dep in luajit python@3.8 python@3.10 python@3.11; do find /usr/local/Homebrew/Library/Taps/homebrew/homebrew-core/Formula -iname $dep.rb -exec sed -i "" $'s/MacOS.version/"10.13"/' {} +;done

          # Patch formulas for 10.13 deployment
          patch -d$(brew --repository)/Library/Taps/deus0ww/homebrew-tap -p0 < ffpmeg.rb.patch
          patch -d$(brew --repository)/Library/Taps/deus0ww/homebrew-tap -p0 < mpv.rb.patch
          patch -d$(brew --repository)/Library/Taps/deus0ww/homebrew-tap -p0 < libplacebo.rb.patch
          patch -d$(brew --repository)/Library/Taps/deus0ww/homebrew-tap -p0 < yt-dlp.rb.patch
          echo ${{ steps.mpv_tag.outputs.tag }}-${{ github.run_number }}>VERSION

          # Uninstal bottled dependencies
          brew uninstall --ignore-dependencies --force openssl
          brew uninstall --ignore-dependencies --force gnutls
          brew uninstall --ignore-dependencies --force jpeg-xl
          brew uninstall --ignore-dependencies --force aom
          brew uninstall --ignore-dependencies --force luajit mujs uchardet zimg gmp coreutils deus0ww/tap/dockutil@2 tag trash lz4 xz zstd jpeg-turbo libtiff little-cms2 libdvdcss libdvdread libdvdnav libb2 libarchive readline sqlite ca-certificates openssl@3 libssh2 aria2 libffi mpdecimal python@3.11 deus0ww/tap/yt-dlp vulkan-loader sdl2 deus0ww/tap/glslang deus0ww/tap/libplacebo libunibreak icu4c graphite2 glib libpng freetype pixman lzo xorgproto libxdmcp libxau libxcb libx11 libxrender libxext fontconfig cairo harfbuzz fribidi deus0ww/tap/libass zimg xvid x265 x264 giflib webp libogg libvorbis theora svt-av1 srt speex opus mpg123 lame flac libsndfile libsamplerate rubberband openjpeg opencore-amr libvpx libvidstab libsoxr mbedtls cjson librist libbs2b libbluray frei0r fdk-aac cunit deus0ww/tap/libmysofa imath openexr highway brotli deus0ww/tap/jpeg-xl deus0ww/tap/aom dav1d aribb24 deus0ww/tap/ffmpeg
          brew cleanup

          cd homebrew-bottles
          git config user.name github-actions
          git config user.email github-actions@github.com
          git config http.postBuffer 524288000
          # Unpack homebrew bottles and link them
          tar -xf *gz -C $(brew --prefix)/Cellar/
          brew link --overwrite -f luajit
          brew link --overwrite -f mujs
          brew link --overwrite -f uchardet
          brew link --overwrite -f gmp
          brew link --overwrite -f coreutils
          brew link --overwrite -f deus0ww/tap/dockutil@2
          brew link --overwrite -f tag
          brew link --overwrite -f trash
          brew link --overwrite -f lz4
          brew link --overwrite -f xz
          brew link --overwrite -f little-cms2
          brew link --overwrite -f libdvdcss
          brew link --overwrite -f libdvdread
          brew link --overwrite -f libb2
          brew link --overwrite -f libarchive
          brew link --overwrite -f readline
          brew link --overwrite -f sqlite
          brew link --overwrite -f ca-certificates
          brew link --overwrite -f libssh2
          brew link --overwrite -f gettext
          brew link --overwrite -f aria2
          brew link --overwrite -f libffi
          brew link --overwrite -f mpdecimal
          # Reinstall homebrew packages from source
          brew install --build-bottle --ignore-dependencies -f libnghttp2 && brew bottle libnghttp2 && git add . && git commit -m 'Added libnghttp2  bottle' && git push
          brew install --build-bottle --ignore-dependencies -f openssl@3 && brew bottle openssl@3 && git add . && git commit -m 'Added openssl@3  bottle' && git push
          brew install --build-bottle --ignore-dependencies -f rtmpdump && brew bottle rtmpdump && git add . && git commit -m 'Added rtmpdump  bottle' && git push
          brew install --build-bottle --ignore-dependencies -f openldap && brew bottle openldap && git add . && git commit -m 'Added openldap  bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libnghttp2 && brew bottle libnghttp2 && git add . && git commit -m 'Added libnghttp2  bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libunistring && brew bottle libunistring && git add . && git commit -m 'Added libunistring  bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libidn2 && brew bottle libidn2 && git add . && git commit -m 'Added libidn2  bottle' && git push
          brew install --build-bottle --ignore-dependencies -f brotli && brew bottle brotli && git add . && git commit -m 'Added brotli  bottle' && git push
          brew install --build-bottle --ignore-dependencies -f curl && brew bottle curl && git add . && git commit -m 'Added curl  bottle' && git push
          brew install --build-bottle --ignore-dependencies -f pcre2 && brew bottle pcre2 && git add . && git commit -m 'Added pcre2  bottle' && git push
          exit 1          
          brew install --build-bottle --ignore-dependencies -f zimg && brew bottle --no-rebuild zimg && git add . && git commit -m 'Added zimg bottle' && git push
          brew install --build-bottle --ignore-dependencies -f zstd && brew bottle --no-rebuild zstd && git add . && git commit -m 'Added zstd bottle' && git push
          brew install --build-bottle --ignore-dependencies -f jpeg-turbo && brew bottle --no-rebuild jpeg-turbo && git add . && git commit -m 'Added jpeg-turbo bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libtiff && brew bottle --no-rebuild libtiff && git add . && git commit -m 'Added libtiff bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libdvdnav && brew bottle --no-rebuild libdvdnav && git add . && git commit -m 'Added libdvdnav bottle' && git push
          brew install --build-bottle --ignore-dependencies -f openssl@3 && brew bottle --no-rebuild openssl@3 && git add . && git commit -m 'Added openssl@3 bottle' && git push
          brew install --build-bottle --ignore-dependencies -f python@3.11 && brew bottle --no-rebuild python@3.11 && git add . && git commit -m 'Added python@3.11 bottle' && git push
          brew install --build-bottle --ignore-dependencies -f deus0ww/tap/yt-dlp && brew bottle --no-rebuild deus0ww/tap/yt-dlp && git add . && git commit -m 'Added deus0ww/tap/yt-dlp bottle' && git push
          brew install --build-bottle --ignore-dependencies -f vulkan-loader && brew bottle --no-rebuild vulkan-loader && git add . && git commit -m 'Added vulkan-loader bottle' && git push
          brew install --build-bottle --ignore-dependencies -f sdl2 && brew bottle --no-rebuild sdl2 && git add . && git commit -m 'Added sdl2 bottle' && git push
          brew install --build-bottle --ignore-dependencies -f deus0ww/tap/glslang && brew bottle --no-rebuild deus0ww/tap/glslang && git add . && git commit -m 'Added deus0ww/tap/glslang bottle' && git push
          brew install --build-bottle --ignore-dependencies -f deus0ww/tap/libplacebo && brew bottle --no-rebuild deus0ww/tap/libplacebo && git add . && git commit -m 'Added deus0ww/tap/libplacebo bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libunibreak && brew bottle --no-rebuild libunibreak && git add . && git commit -m 'Added libunibreak bottle' && git push
          brew install --build-bottle --ignore-dependencies -f icu4c && brew bottle --no-rebuild icu4c && git add . && git commit -m 'Added icu4c bottle' && git push
          brew install --build-bottle --ignore-dependencies -f graphite2 && brew bottle --no-rebuild graphite2 && git add . && git commit -m 'Added graphite2 bottle' && git push
          brew install --build-bottle --ignore-dependencies -f pcre2 && brew bottle --no-rebuild pcre2 && git add . && git commit -m 'Added pcre2 bottle' && git push
          brew install --build-bottle --ignore-dependencies -f glib && brew bottle --no-rebuild glib && git add . && git commit -m 'Added glib bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libpng && brew bottle --no-rebuild libpng && git add . && git commit -m 'Added libpng bottle' && git push
          brew install --build-bottle --ignore-dependencies -f freetype && brew bottle --no-rebuild freetype && git add . && git commit -m 'Added freetype bottle' && git push
          brew install --build-bottle --ignore-dependencies -f pixman && brew bottle --no-rebuild pixman && git add . && git commit -m 'Added pixman bottle' && git push
          brew install --build-bottle --ignore-dependencies -f lzo && brew bottle --no-rebuild lzo && git add . && git commit -m 'Added lzo bottle' && git push
          brew install --build-bottle --ignore-dependencies -f xorgproto && brew bottle --no-rebuild xorgproto && git add . && git commit -m 'Added xorgproto bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libxdmcp && brew bottle --no-rebuild libxdmcp && git add . && git commit -m 'Added libxdmcp bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libxau && brew bottle --no-rebuild libxau && git add . && git commit -m 'Added libxau bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libxcb && brew bottle --no-rebuild libxcb && git add . && git commit -m 'Added libxcb bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libx11 && brew bottle --no-rebuild libx11 && git add . && git commit -m 'Added libx11 bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libxrender && brew bottle --no-rebuild libxrender && git add . && git commit -m 'Added libxrender bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libxext && brew bottle --no-rebuild libxext && git add . && git commit -m 'Added libxext bottle' && git push
          brew install --build-bottle --ignore-dependencies -f fontconfig && brew bottle --no-rebuild fontconfig && git add . && git commit -m 'Added fontconfig bottle' && git push
          brew install --build-bottle --ignore-dependencies -f cairo && brew bottle --no-rebuild cairo && git add . && git commit -m 'Added cairo bottle' && git push
          brew install --build-bottle --ignore-dependencies -f harfbuzz && brew bottle --no-rebuild harfbuzz && git add . && git commit -m 'Added harfbuzz bottle' && git push
          brew install --build-bottle --ignore-dependencies -f fribidi && brew bottle --no-rebuild fribidi && git add . && git commit -m 'Added fribidi bottle' && git push
          brew install --build-bottle --ignore-dependencies -f deus0ww/tap/libass && brew bottle --no-rebuild deus0ww/tap/libass && git add . && git commit -m 'Added deus0ww/tap/libass bottle' && git push
          brew install --build-bottle --ignore-dependencies -f zimg && brew bottle --no-rebuild zimg && git add . && git commit -m 'Added zimg bottle' && git push
          brew install --build-bottle --ignore-dependencies -f xvid && brew bottle --no-rebuild xvid && git add . && git commit -m 'Added xvid bottle' && git push
          brew install --build-bottle --ignore-dependencies -f x265 && brew bottle --no-rebuild x265 && git add . && git commit -m 'Added x265 bottle' && git push
          brew install --build-bottle --ignore-dependencies -f x264 && brew bottle --no-rebuild x264 && git add . && git commit -m 'Added x264 bottle' && git push
          brew install --build-bottle --ignore-dependencies -f giflib && brew bottle --no-rebuild giflib && git add . && git commit -m 'Added giflib bottle' && git push
          brew install --build-bottle --ignore-dependencies -f webp && brew bottle --no-rebuild webp && git add . && git commit -m 'Added webp bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libogg && brew bottle --no-rebuild libogg && git add . && git commit -m 'Added libogg bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libvorbis && brew bottle --no-rebuild libvorbis && git add . && git commit -m 'Added libvorbis bottle' && git push
          brew install --build-bottle --ignore-dependencies -f theora && brew bottle --no-rebuild theora && git add . && git commit -m 'Added theora bottle' && git push
          brew install --build-bottle --ignore-dependencies -f svt-av1 && brew bottle --no-rebuild svt-av1 && git add . && git commit -m 'Added svt-av1 bottle' && git push
          brew install --build-bottle --ignore-dependencies -f srt && brew bottle --no-rebuild srt && git add . && git commit -m 'Added srt bottle' && git push
          brew install --build-bottle --ignore-dependencies -f speex && brew bottle --no-rebuild speex && git add . && git commit -m 'Added speex bottle' && git push
          brew install --build-bottle --ignore-dependencies -f opus && brew bottle --no-rebuild opus && git add . && git commit -m 'Added opus bottle' && git push
          brew install --build-bottle --ignore-dependencies -f mpg123 && brew bottle --no-rebuild mpg123 && git add . && git commit -m 'Added mpg123 bottle' && git push
          brew install --build-bottle --ignore-dependencies -f lame && brew bottle --no-rebuild lame && git add . && git commit -m 'Added lame bottle' && git push
          brew install --build-bottle --ignore-dependencies -f flac && brew bottle --no-rebuild flac && git add . && git commit -m 'Added flac bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libsndfile && brew bottle --no-rebuild libsndfile && git add . && git commit -m 'Added libsndfile bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libsamplerate && brew bottle --no-rebuild libsamplerate && git add . && git commit -m 'Added libsamplerate bottle' && git push
          brew install --build-bottle --ignore-dependencies -f rubberband && brew bottle --no-rebuild rubberband && git add . && git commit -m 'Added rubberband bottle' && git push
          brew install --build-bottle --ignore-dependencies -f openjpeg && brew bottle --no-rebuild openjpeg && git add . && git commit -m 'Added openjpeg bottle' && git push
          brew install --build-bottle --ignore-dependencies -f opencore-amr && brew bottle --no-rebuild opencore-amr && git add . && git commit -m 'Added opencore-amr bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libvpx && brew bottle --no-rebuild libvpx && git add . && git commit -m 'Added libvpx bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libvidstab && brew bottle --no-rebuild libvidstab && git add . && git commit -m 'Added libvidstab bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libsoxr && brew bottle --no-rebuild libsoxr && git add . && git commit -m 'Added libsoxr bottle' && git push
          brew install --build-bottle --ignore-dependencies -f mbedtls && brew bottle --no-rebuild mbedtls && git add . && git commit -m 'Added mbedtls bottle' && git push
          brew install --build-bottle --ignore-dependencies -f cjson && brew bottle --no-rebuild cjson && git add . && git commit -m 'Added cjson bottle' && git push
          brew install --build-bottle --ignore-dependencies -f librist && brew bottle --no-rebuild librist && git add . && git commit -m 'Added librist bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libbs2b && brew bottle --no-rebuild libbs2b && git add . && git commit -m 'Added libbs2b bottle' && git push
          brew install --build-bottle --ignore-dependencies -f libbluray && brew bottle --no-rebuild libbluray && git add . && git commit -m 'Added libbluray bottle' && git push
          brew install --build-bottle --ignore-dependencies -f frei0r && brew bottle --no-rebuild frei0r && git add . && git commit -m 'Added frei0r bottle' && git push
          brew install --build-bottle --ignore-dependencies -f fdk-aac && brew bottle --no-rebuild fdk-aac && git add . && git commit -m 'Added fdk-aac bottle' && git push
          brew install --build-bottle --ignore-dependencies -f cunit && brew bottle --no-rebuild cunit && git add . && git commit -m 'Added cunit bottle' && git push
          brew install --build-bottle --ignore-dependencies -f deus0ww/tap/libmysofa && brew bottle --no-rebuild deus0ww/tap/libmysofa && git add . && git commit -m 'Added deus0ww/tap/libmysofa bottle' && git push
          brew install --build-bottle --ignore-dependencies -f imath && brew bottle --no-rebuild imath && git add . && git commit -m 'Added imath bottle' && git push
          brew install --build-bottle --ignore-dependencies -f openexr && brew bottle --no-rebuild openexr && git add . && git commit -m 'Added openexr bottle' && git push
          brew install --build-bottle --ignore-dependencies -f highway && brew bottle --no-rebuild highway && git add . && git commit -m 'Added highway bottle' && git push
          brew install --build-bottle --ignore-dependencies -f brotli && brew bottle --no-rebuild brotli && git add . && git commit -m 'Added brotli bottle' && git push
          brew install --build-bottle --ignore-dependencies -f deus0ww/tap/jpeg-xl && brew bottle --no-rebuild deus0ww/tap/jpeg-xl && git add . && git commit -m 'Added deus0ww/tap/jpeg-xl bottle' && git push
          brew install --build-bottle --ignore-dependencies -f deus0ww/tap/aom && brew bottle --no-rebuild deus0ww/tap/aom && git add . && git commit -m 'Added deus0ww/tap/aom bottle' && git push
          brew install --build-bottle --ignore-dependencies -f dav1d && brew bottle --no-rebuild dav1d && git add . && git commit -m 'Added dav1d bottle' && git push
          brew install --build-bottle --ignore-dependencies -f aribb24 && brew bottle --no-rebuild aribb24 && git add . && git commit -m 'Added aribb24 bottle' && git push
          brew install --build-bottle --ignore-dependencies -f deus0ww/tap/ffmpeg && brew bottle --no-rebuild deus0ww/tap/ffmpeg && git add . && git commit -m 'Added deus0ww/tap/ffmpeg bottle' && git push
          exit 1

          #brew reinstall -f -s luajit mujs uchardet zimg gmp coreutils deus0ww/tap/dockutil@2 tag trash lz4 xz zstd jpeg-turbo libtiff little-cms2 libdvdcss libdvdread libdvdnav libb2 libarchive readline sqlite ca-certificates openssl@3 libssh2 gettext aria2 libffi mpdecimal python@3.11 deus0ww/tap/yt-dlp vulkan-loader sdl2 deus0ww/tap/glslang deus0ww/tap/libplacebo libunibreak icu4c graphite2 pcre2 glib libpng freetype pixman lzo xorgproto libxdmcp libxau libxcb libx11 libxrender libxext fontconfig cairo harfbuzz fribidi deus0ww/tap/libass zimg xvid x265 x264 giflib webp libogg libvorbis theora svt-av1 srt speex opus mpg123 lame flac libsndfile libsamplerate rubberband openjpeg opencore-amr libvpx libvidstab libsoxr mbedtls cjson librist libbs2b libbluray frei0r fdk-aac cunit deus0ww/tap/libmysofa imath openexr highway brotli deus0ww/tap/jpeg-xl deus0ww/tap/aom dav1d aribb24 deus0ww/tap/ffmpeg
          LDFLAGS=-L/usr/local/opt/libiconv/lib CPPFLAGS=-L/usr/local/opt/libiconv/include brew install --ignore-dependencies -v --HEAD deus0ww/tap/mpv

          FFMPEGINFO=$(ffmpeg -version)
          FFMPEGINFO="${FFMPEGINFO//'%'/'%25'}"
          FFMPEGINFO="${FFMPEGINFO//$'\n'/'%0A'}"
          FFMPEGINFO="${FFMPEGINFO//$'\r'/'%0D'}"
          echo "::set-output name=FFMPEG_INFO::$FFMPEGINFO"

      - name: Build Apple Disk Image
        run: |
          mkdir /tmp/mpv-release
          cp -r /usr/local/Cellar/mpv/*/mpv.app /tmp/mpv-release
          #rsync -avrz --no-links /usr/local/opt/ /tmp/mpv-release/lib/
          #cp background.tiff /tmp/background.tiff
          cp icon.icns /tmp/icon.icns
          cd /tmp/mpv-release
          brew install create-dmg dylibbundler
          dylibbundler -od -b -x ./mpv.app/Contents/MacOS/mpv -d ./mpv.app/Contents/libs/
          create-dmg --no-internet-enable --volname "mpv" --volicon "/tmp/icon.icns" --background "/tmp/background.tiff" --window-pos 200 120 --window-size 573 400 --icon-size 80 --icon "mpv.app" 200 175 --hide-extension "mpv.app" --app-drop-link 375 175 /tmp/mpv.dmg /tmp/mpv-release

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.mpv_tag.outputs.tag }}-${{ github.run_number }}
          release_name: mpv build ${{ steps.mpv_tag.outputs.tag }}
          body: |
              - Build date: `${{ steps.timestamp.outputs.date }}`
              - Version: `${{ steps.mpv_tag.outputs.tag }} (commit: ${{ steps.mpv_tag.outputs.tag }})`
              - OS support: `macOS High Sierra 10.13 or later`
              - Workflow run number: `${{ github.run_number }}`
              - FFMPEG info:
              ```
              ${{ steps.build_mpv.outputs.FFMPEG_INFO }}
              ```
          draft: false
          prerelease: false

      - name: Upload Release Asset
        id: upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: /tmp/mpv.dmg
          asset_name: mpv-${{ steps.mpv_tag.outputs.tag }}-${{ github.run_number }}.dmg
          asset_content_type: application/x-apple-diskimage
