name: build

on:
  push:
    branches:
      - main
  #schedule:
    # nightly build
    #- cron: "00 12 * * *"

jobs:
  install_deps:
    name: Check out latest mpv from git and install dependecies
    runs-on: macos-latest
    env:
      CC: clang
      CXX: clang++
      HOMEBREW_NO_ANALYTICS: 1
      HOMEBREW_NO_INSTALL_CLEANUP: 1
      HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1
      HOMEBREW_SDKROOT: "/Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
      MACOSX_DEPLOYMENT_TARGET: 10.13
      SDKROOT: "/Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
      MACOS_SDK: "/Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
      SDK_PATH: "/Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs"
      EXTRA_CFLAGS: "-mmacosx-version-min=10.13 -isysroot /Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
      EXTRA_CXXFLAGS: "-mmacosx-version-min=10.13 -isysroot /Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
      EXTRA_LDFLAGS: "-mmacosx-version-min=10.13 -isysroot /Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
      SWIFT_FLAGS: "-target x86_64-apple-macosx10.13"
    steps:
      - name: Get current timestamp
        id: timestamp
        run: |
          echo "::set-output name=timestamp::$(date +%s)"
          echo "::set-output name=date::$(date +%Y%m%d)"

      - name: Get latest mpv git tag
        id: mpv_tag
        uses: oprypin/find-latest-tag@v1
        with:
          repository: 'mpv-player/mpv'
          releases-only: false

      - name: Checkout dafyk/mpv-macos-builds
        uses: actions/checkout@v3
        with:
          repository: 'dafyk/mpv-macos-builds'
          fetch-depth: 0
          submodules: true

      - name: Install MacOSX 10.14 SDK
        id: macossdk
        run: |
          # MacOSX10.14 SDK
          tar -C $SDK_PATH -xf MacOSX10.14.sdk.tar.xz
          sudo rm -rf $SDK_PATH/MacOSX11.3.sdk
          sudo mv $SDK_PATH/MacOSX.sdk $SDK_PATH/MacOSX11.3.sdk
          sudo ln -s $SDK_PATH/MacOSX10.14.sdk $SDK_PATH/MacOSX.sdk
          sudo /usr/libexec/PlistBuddy -c "Set :MinimumSDKVersion 10.14" /Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Info.plist

      - name: Install Swift 4.x toolchain
        id: swift4
        run: |
          # Swift 4.x toolchain
          curl -ksJLO https://download.swift.org/swift-4.2.4-release/xcode/swift-4.2.4-RELEASE/swift-4.2.4-RELEASE-osx.pkg
          sudo installer -pkg swift-4.2.4-RELEASE-osx.pkg -target /

      - name: Install Vulkan SDK
        id: vulkansdk
        run: |
          # Vulkan SDK
          curl -ksJLO https://sdk.lunarg.com/sdk/download/latest/mac/vulkan-sdk.dmg
          hdiutil attach vulkansdk*.dmg
          sudo /Volumes/vulkansdk*/InstallVulkan.app/Contents/MacOS/InstallVulkan --root /usr/local/vulkansdk --accept-licenses --default-answer --confirm-command install
          # Fix "No such file or directory: '@rpath/libshaderc_shared.1.dylib'" when bundling mpv.app
          # https://github.com/achirkin/vulkan/blob/master/README-macOS.md#workaround-for-compile-time-linking-vulkan-api
          #install_name_tool -id /usr/local/vulkansdk/macOS/lib/libshaderc_shared.1.dylib /usr/local/vulkansdk/macOS/lib/libshaderc_shared.1.dylib
          #install_name_tool -id /usr/local/vulkansdk/macOS/lib/libspirv-cross-c-shared.0.dylib /usr/local/vulkansdk/macOS/lib/libspirv-cross-c-shared.0.dylib
          #install_name_tool -id /usr/local/vulkansdk/macOS/lib/libvulkan.1.dylib /usr/local/vulkansdk/macOS/lib/libvulkan.1.dylib

      - name: Switch to Xcode 12.5.1
        id: xcode1251
        run: |
          # Switch to Xcode 12.5.1
          sudo xcode-select --reset
          sudo xcode-select -s /Applications/Xcode_12.5.1.app/Contents/Developer

      - name: Force 10.13 deployment target for all homebrew formulas
        id: homebrew1013
        run: |
          # Force 10.13 deployment target for all homebrew formulas
          brew update-reset
          for dep in $(brew --repository)/Library/Taps/homebrew/homebrew-core/Formula/*.rb; do sed -i "" $'s/def install/def install\\\n    ENV["MACOSX_DEPLOYMENT_TARGET"] = "10.13"\\\n/' $dep;done
          for dep in luajit python@3.8; do sed -i "" $'s/MacOS.version/"10.13"/' $(brew --repository)/Library/Taps/homebrew/homebrew-core/Formula//$dep.rb;done

      - name: Uninstal homebrew bottled dependencies
        id: homebrewuninst
        run: |
          # Uninstal bottled dependencies
          brew uninstall --ignore-dependencies --force openssl
          brew uninstall --ignore-dependencies --force gnutls
          brew cleanup
