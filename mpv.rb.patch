--- mpv.rb.orig	2023-10-05 07:02:16.000000000 +0200
+++ mpv.rb	2023-10-06 11:33:59.000000000 +0200
@@ -24,16 +24,18 @@
   depends_on "mujs"
   depends_on "uchardet"
   depends_on "zimg"
-
-  depends_on "libbluray" => :optional
-  depends_on "rubberband" => :optional
-  depends_on "sdl2" => :optional
-  depends_on "vapoursynth" => :optional
+  depends_on "libiconv"
+  depends_on "zlib"
+  depends_on "libdvdcss"
+  depends_on "libdvdread"
+  depends_on "libdvdnav"
+  depends_on "libbluray"
+  depends_on "rubberband"
+  depends_on "sdl2"
 
   on_macos do
     depends_on "coreutils" => :recommended
-    depends_on "deus0ww/tap/dockutil@2" => :recommended if MacOS.version <  :big_sur
-    depends_on "deus0ww/tap/dockutil@3" => :recommended if MacOS.version >= :big_sur
+    depends_on "deus0ww/tap/dockutil@2" => :recommended
     depends_on "tag" => :recommended
     depends_on "trash" => :recommended
   end
@@ -42,6 +44,11 @@
     depends_on "alsa-lib"
   end
 
+  patch do
+    url "https://raw.githubusercontent.com/dafyk/mpv-macos-builds/main/swift_compat.patch"
+    sha256 "3c4d1ce9dcfef9ce0656b49b5f40606fcf2fc890e60599817090cb2f7da98d41"
+  end
+
   def install
     ENV["MACOSX_DEPLOYMENT_TARGET"] = "10.13"
     # LANG is unset by default on macOS and causes issues when calling getlocale
@@ -59,11 +66,38 @@
     args = %W[
       -Db_lto=true
       -Db_lto_mode=thin
-
+      -Dhtml-build=disabled
+      -Dmanpage-build=disabled
+      -Dpdf-build=disabled
+      -Dx11=disabled
+      -Dmacos-10-14-features=disabled
+      -Dmacos-touchbar=disabled
+      -Dtests=false
+      -Dvapoursynth=disabled
+      -Dcplayer=true
       -Dlibmpv=true
+      -Dcocoa=enabled
+      -Dgl-cocoa=enabled
+      -Dmacos-cocoa-cb=enabled
+      -Dplain-gl=enabled
+      -Dmacos-media-player=enabled
+      -Dcoreaudio=enabled
+      -Dcplugins=enabled
       -Ddvdnav=enabled
-
-      --default-library=both
+      -Dgl=enabled
+      -Djavascript=enabled
+      -Dlcms2=enabled
+      -Dlibplacebo=enabled
+      -Dlua=luajit
+      -Duchardet=disabled
+      -Dvideotoolbox-gl=enabled
+      -Dvulkan=disabled
+      -Dzimg=enabled
+      -Dzlib=enabled
+      -Dlibarchive=enabled
+      -Dshaderc=disabled
+      --default-library=static
+      --prefer-static
       --sysconfdir=#{pkgetc}
       --datadir=#{pkgshare}
       --mandir=#{man}
@@ -71,7 +105,7 @@
     args << "-Dsdl2=enabled" if build.with? "sdl2"
     
     args << ("-Dc_args=" + (Hardware::CPU.arm? ? "-mcpu=native" : "-march=native -mtune=native") + " -Ofast")
-    args << "-Dswift-flags=-O -wmo"
+    args << "-Dswift-flags=-O -wmo -target x86_64-apple-macosx10.13"
 
     system "meson", "setup", "build", *args, *std_meson_args
     system "meson", "compile", "-C", "build", "--verbose"
@@ -105,12 +139,4 @@
       system "dockutil", "--add", "#{prefix}/mpv.app", "--replacing", "mpv", "--allhomes"
     end
   end
-
-  test do
-    system bin/"mpv", "--ao=null", "--vo=null", test_fixtures("test.wav")
-    assert_match "vapoursynth", shell_output(bin/"mpv --vf=help")
-
-    # Make sure `pkg-config` can parse `mpv.pc` after the `inreplace`.
-    system "pkg-config", "mpv"
-  end
 end
